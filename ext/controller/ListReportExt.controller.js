/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/ui/core/mvc/Controller","sap/ui/core/Popup","cus/sd/so/mccs1/ext/commons/TabUtility","cus/sd/so/mccs1/ext/commons/ODataDataSource","cus/sd/so/mccs1/ext/commons/constants"],function(M,J,a,F,b,c,C,P,T,O,d){"use strict";return sap.ui.controller("cus.sd.so.mccs1.ext.controller.ListReportExt",{_tabUtility:null,_ODataDataSource:null,_massChgActionsComponent:null,_quickViewComponent:null,_partnerInfoPopup:null,_actionChangeMenu:null,_actionCheckMenu:null,_actionCreateMenu:null,_selectAllFlag:false,_actionFragments:{},onInit:function(){this._tabUtility=T.getInstance();this._actionFragments={};this._tabUtility.setExtensionApi(this.extensionAPI);this._ODataDataSource=new O(this.getOwnerComponent().getModel());this.getView().byId("listReport-_tab1").setIgnoreFromPersonalisation(d.IGNORE_FIELDS_LIST.SALESORDER);this.getView().byId("listReport-_tab2").setIgnoreFromPersonalisation(d.IGNORE_FIELDS_LIST.SALESORDERITEM);try{this._massChgActionsComponent=sap.ui.getCore().createComponent({name:"cus.sd.libmccs1.components.actions",settings:{extensionAPI:this.extensionAPI,model:this.getOwnerComponent().getModel()}});this._quickViewComponent=sap.ui.getCore().createComponent({name:"cus.sd.libmccs1.components.quickview",settings:{model:this.getOwnerComponent().getModel()}});}catch(e){}this.getOwnerComponent().getModel().attachBatchRequestCompleted(this._batchRequestedComplete.bind(this));var s=this.getView().byId("listReportFilter");s.attachFilterChange(this.onFilterValueChange.bind(this));this._iconTabInit();this._initJSONModel();this._actionBtnInit();try{this.getOwnerComponent().getService("ShellUIService").then(function(S){S.setBackNavigation(function(){this._onTabSelect();window.history.back();}.bind(this));}.bind(this));}catch(f){}try{this.getOwnerComponent().getService("ShellUIService").then(function(S){S.setBackNavigation(function(){this._onTabSelect();window.history.back();}.bind(this));}.bind(this));}catch(f){}this.getOwnerComponent().getModel().attachBatchRequestCompleted(this._batchRequestedComplete.bind(this));},_actionBtnInit:function(){var h="/"+d.ENTITY_LEVEL.IF_SALES_ORDER;var i="/"+d.ENTITY_LEVEL.IF_SALES_ORDER_ITEMS;var t=function(D){if(D&&D.length){return true;}return false;};this.getView().byId(d.ACTIONBTNID.CHGICONHDR).setIcon("sap-icon://slim-arrow-down");this.getView().byId(d.ACTIONBTNID.CHGICONHDR).setProperty("iconFirst",false);this.getView().byId(d.ACTIONBTNID.CHGICONITM).setIcon("sap-icon://slim-arrow-down");this.getView().byId(d.ACTIONBTNID.CHGICONITM).setProperty("iconFirst",false);this.getView().byId(d.ACTIONBTNID.CHGICONHDR).bindProperty("visible",{path:h+"/change",model:"actionModel",formatter:t});this.getView().byId(d.ACTIONBTNID.CHGICONITM).bindProperty("visible",{path:i+"/change",model:"actionModel",formatter:t});this.getView().byId(d.ACTIONBTNID.CHKICONHDR).setIcon("sap-icon://slim-arrow-down");this.getView().byId(d.ACTIONBTNID.CHKICONHDR).setProperty("iconFirst",false);this.getView().byId(d.ACTIONBTNID.CHKICONITM).setIcon("sap-icon://slim-arrow-down");this.getView().byId(d.ACTIONBTNID.CHKICONITM).setProperty("iconFirst",false);this.getView().byId(d.ACTIONBTNID.CHKICONHDR).bindProperty("visible",{path:h+"/check",model:"actionModel",formatter:t});this.getView().byId(d.ACTIONBTNID.CHKICONITM).bindProperty("visible",{path:i+"/check",model:"actionModel",formatter:t});},_iconTabInit:function(){var I=d.ID;var o=this.byId(I.ICON_TABBAR);o.attachSelect(this._onTabSelect.bind(this));var s=this.getView().byId("listReport-_tab1");s.getCustomToolbar().insertContent(new sap.m.Text({text:'{uiModel>/'+I.SALES_ORDER_TAB+'}'}));var S=this.getView().byId("listReport-_tab2");S.getCustomToolbar().insertContent(new sap.m.Text({text:'{uiModel>/'+I.SALES_ORDER_ITEMS_TAB+'}'}));var t=[s,S];for(var i=0;i<t.length;i++){var e=t[i].getTable();e.attachSelectionChange(this.onRowSelectionChange.bind(this));e.attachUpdateFinished(this.onUpdateFinished.bind(this));e.setSticky([sap.m.Sticky.HeaderToolbar,sap.m.Sticky.ColumnHeaders]);}this._getActionMenuItems();},_initJSONModel:function(){var u=new J({HeaderPartner:{bCustomerSelected:true,bPartnerSelected:false},jobFieldEnabled:true,backgroundJobOption:"Yes",backgroundJobFieldValue:d.JOB_NAME_PREFIX,changePartnerSelected:false,removePartnerSelected:true,actionId:null});u.setProperty("/"+d.ID.SALES_ORDER_TAB,"");u.setProperty("/"+d.ID.SALES_ORDER_ITEMS_TAB,"");u.setProperty("/"+d.ID.SCHEDULE_LINES_TAB,"");this.getView().setModel(u,"uiModel");var D=new J({changeAttributes:[{key:"",value:""}]});var A=new J({H:{change:null,create:null,check:null},I:{change:null,create:null,check:null},actionData:{change:null,create:null,check:null}});this.getView().setModel(D,"dataModel");this.getView().setModel(A,"actionModel");},onUpdateFinished:function(e){var I=e.getSource().getItems();if(!I.length||e.getParameter('reason')==="Refresh"){this._clearSelection();}if(e.getParameter('reason')==="Growing"){if(this._tabUtility.getSelectOption()&&this._tabUtility.getSelectOption()!==d.ROW_SELECTION_CASE.IF_INCLUSION){if(I.length){var f=I.length-20;for(var i=I.length-1;i>=f;i--){I[i].setSelected(true);}}}}},_showSelectedItemsCount:function(s,S){var i=0;var e=this._tabUtility.getSelectOption();var t=this._tabUtility.getTabSelected();var u=this.getView().getModel("uiModel");if(e===d.ROW_SELECTION_CASE.IF_SELECT_ALL){i=s.getMaxItemsCount();}else if(e===d.ROW_SELECTION_CASE.IF_EXCLUSION){i=parseInt(u.getProperty("/"+t).split(" ")[0],10);i=S?(i+1):(i-1);}else{i=s.getSelectedItems().length;}var f=this.getView().getModel("@i18n").getResourceBundle().getText("listReport.selectedText");u.setProperty("/"+t,i?(i+" "+f):"");},onRowSelectionChange:function(e){var s=e.getSource().getSelectedItems();var S=false;if(e.getParameter("selectAll")){this._tabUtility.setSelectOption(d.ROW_SELECTION_CASE.IF_SELECT_ALL);this._selectAllFlag=true;this._tabUtility.setExclusionList([]);}else if(s.length&&this._selectAllFlag){this._tabUtility.setSelectOption(d.ROW_SELECTION_CASE.IF_EXCLUSION);var o=e.getParameter("listItem").getBindingContext();S=e.getParameter("selected");this._tabUtility.updateExlusionList(o,S);}else{this._tabUtility.setSelectOption(d.ROW_SELECTION_CASE.IF_INCLUSION);this._selectAllFlag=false;this._tabUtility.setExclusionList([]);}this._showSelectedItemsCount(e.getSource(),e.getParameter("selected"));},_onTabSelect:function(e){this._selectAllFlag=false;this._clearSelection();this._tabUtility.clear();},_clearSelection:function(){var u=this.getView().getModel("uiModel");var s=this.getView().byId("listReport-_tab1").getTable();s.removeSelections();var S=this.getView().byId("listReport-_tab2").getTable();S.removeSelections();u.setProperty("/"+d.ID.SALES_ORDER_TAB,"");u.setProperty("/"+d.ID.SALES_ORDER_ITEMS_TAB,"");},onFilterValueChange:function(e){this._clearSelection();var p=this.byId(d.ID.FILTERS.PARTNER_FUNCTION);var f=e.getSource();var o=f.getFilterData();this._validateAndSetFilterState(d.DB_FIELD_NAMES.CUSTOMER,d.ID.FILTERS.CUSTOMER,o);this._validateAndSetFilterState(d.DB_FIELD_NAMES.CONTACT_PERSON,d.ID.FILTERS.CONTACT_PERSON,o);this._validateAndSetFilterState(d.DB_FIELD_NAMES.PERSONNEL,d.ID.FILTERS.PERSONNEL,o);this._validateAndSetFilterState(d.DB_FIELD_NAMES.SUPPLIER,d.ID.FILTERS.SUPPLIER,o);if(o.hasOwnProperty(d.DB_FIELD_NAMES.PARTNER_FUNCTION)){var s=p.getSelectedItem();if(s){this.sPartnerType=s.getBindingContext().getObject().SDDocumentPartnerType;this._validatePartnerFunctionFilter(this.sPartnerType,o);}else{this._setPartnerTypeAndValidate(o);}}else if(p){p.setValueState("None");}},_setPartnerTypeAndValidate:function(f){var e=[];var o=new F({filters:[new F({path:d.DOCUMENT_CATEGORY.NAME,operator:b.EQ,value1:"\'"+d.DOCUMENT_CATEGORY.IF_SALES_ORDER+"\'"}),new F({path:d.DB_FIELD_NAMES.PARTNER_FUNCTION,operator:b.EQ,value1:"\'"+f.PartnerFunction+"\'"})],and:true});e.push(o);var p=this._ODataDataSource.getPartnerFilterData(e);p.then(function(g,h){if(h.results.length){var s=h.results[0].SDDocumentPartnerType;this._validatePartnerFunctionFilter(s,g);}}.bind(this,f),function(g){M.show(this.i18nBundle.getText("partnerTypeReadFailed"));}.bind(this));},_validateAndSetFilterState:function(f,s,o){if(o.hasOwnProperty(f)){this._validatePartnerFilter(o);}else{var e=this.byId(s);if(e){e.setValueState("None");}}},_validatePartnerFilter:function(f){var p=f.hasOwnProperty(d.DB_FIELD_NAMES.PARTNER_FUNCTION);var o=this.byId(d.ID.FILTERS.PARTNER_FUNCTION);var s=o.getSelectedItem();var e=f.hasOwnProperty(d.DB_FIELD_NAMES.CUSTOMER);var g=f.hasOwnProperty(d.DB_FIELD_NAMES.CONTACT_PERSON);var h=f.hasOwnProperty(d.DB_FIELD_NAMES.PERSONNEL);var S=f.hasOwnProperty(d.DB_FIELD_NAMES.SUPPLIER);var i;var j=this.getView().getModel("@i18n").getResourceBundle().getText("partnerFunctionError");var k=s?s.getBindingContext().getObject().SDDocumentPartnerType:null;if(!p&&e||k!==d.PARTNER_TYPE.CUSTOMER&&e){i=this.byId(d.ID.FILTERS.CUSTOMER);i.setValueState("Error");i.setValueStateText(j);}if(!p&&g||k!==d.PARTNER_TYPE.CONTACT_PERSON&&g){i=this.byId(d.ID.FILTERS.CONTACT_PERSON);i.setValueState("Error");i.setValueStateText(j);}if(!p&&h||k!==d.PARTNER_TYPE.PERSONNEL&&h){i=this.byId(d.ID.FILTERS.PERSONNEL);i.setValueState("Error");i.setValueStateText(j);}if(!p&&S||k!==d.PARTNER_TYPE.SUPPLIER&&S){i=this.byId(d.ID.FILTERS.SUPPLIER);i.setValueState("Error");i.setValueStateText(j);}},_validatePartnerFunctionFilter:function(p,f){var e=f.hasOwnProperty(d.DB_FIELD_NAMES.PARTNER_FUNCTION);var o=this.byId(d.ID.FILTERS.PARTNER_FUNCTION);var E;switch(p){case d.PARTNER_TYPE.CUSTOMER:var g=f.hasOwnProperty(d.DB_FIELD_NAMES.CUSTOMER);var h=this.byId(d.ID.FILTERS.CUSTOMER);E=this.getView().getModel("@i18n").getResourceBundle().getText("customerError");this._setParterTypeErrMsg(e,o,g,h,"customerError");break;case d.PARTNER_TYPE.CONTACT_PERSON:var i=f.hasOwnProperty(d.DB_FIELD_NAMES.CONTACT_PERSON);var j=this.byId(d.ID.FILTERS.CONTACT_PERSON);E=this.getView().getModel("@i18n").getResourceBundle().getText("contactError");this._setParterTypeErrMsg(e,o,i,j,"contactError");break;case d.PARTNER_TYPE.PERSONNEL:var k=f.hasOwnProperty(d.DB_FIELD_NAMES.PERSONNEL);var l=this.byId(d.ID.FILTERS.PERSONNEL);E=this.getView().getModel("@i18n").getResourceBundle().getText("personnelError");this._setParterTypeErrMsg(e,o,k,l,"personnelError");break;case d.PARTNER_TYPE.SUPPLIER:var s=f.hasOwnProperty(d.DB_FIELD_NAMES.SUPPLIER);var S=this.byId(d.ID.FILTERS.SUPPLIER);E=this.getView().getModel("@i18n").getResourceBundle().getText("supplierError");this._setParterTypeErrMsg(e,o,s,S,"supplierError");break;default:o.setValueState("None");break;}},_setParterTypeErrMsg:function(p,o,e,f,g){var r=this.getView().getModel("@i18n").getResourceBundle();if(p&&!e){o.setValueState("Error");o.setValueStateText(r.getText(g));}else if((typeof o!=="undefined")&&(typeof f!=="undefined")){o.setValueState("None");f.setValueState("None");}},_prepareChangeAttributes:function(e){var m=this.getView().getModel("dataModel").getProperty("/changeAttributes");m=[];for(var i=0;i<e.length;i++){m.push(e[i]);}this.getView().getModel("dataModel").setProperty("/changeAttributes",m);},onPartnerChange:function(e){this._oDialog.getBeginButton().setEnabled(true);},handleMenuItemPress:function(e){var i=e.getParameter("item").getCustomData()[0];var f=i.getKey();this.getView().getModel("uiModel").setProperty("/actionId",f);var g=d.MENU_ITEMS;if(f===g.CHANGE_ACTION.HEADER_DATA){this._navToOBjectPage("navigateToHeaderObjectPage");}else if(f===g.CHANGE_ACTION.ITEM_DATA){this._navToOBjectPage("navigateToItemObjectPage");}else{var h=this._tabUtility.getEntityLevel();var j=d.ODATA.ENTITYSET.MC_SALES_ORDER;if(h!==d.ENTITY_LEVEL.IF_SALES_ORDER){j=d.ODATA.ENTITYSET.MC_SALES_ORDER_ITEM;}var s=this._tabUtility.getFilters();var p={entityLevel:h,entitySet:j,selectedContext:this._tabUtility.getSelectedContext(),documentCategory:d.DOCUMENT_CATEGORY.IF_SALES_ORDER,caseType:this._tabUtility.getSelectOption(),actionId:f,actionDescription:i.getValue(),filters:s};this._massChgActionsComponent.openActionDialog(e,p);}},_navToOBjectPage:function(r){var n=this.extensionAPI.getNavigationController();n.navigateInternal("",{routeName:r});},_batchRequestedComplete:function(e){var r=e.getParameter("requests");if(r){for(var i=0;i<r.length;i++){var u=r[i].url;if(u.match(/SlsOrder\/\$count/)||u.match(/SlsOrdItem\/\$count/)){var f=u.match(/\$filter=([^*]+)/);if(f){this._tabUtility.setFilters("?"+f[0]);}else{this._tabUtility.setFilters("");}}}}},showJobSubmitDialog:function(){var u=this.getView().getModel("uiModel");u.setProperty("/backgroundJobFieldValue",d.JOB_NAME_PREFIX+(new Date()).toLocaleDateString());var s=this._tabUtility.getSelectedContext();u.setProperty("/jobFieldEnabled",s.length>10?false:true);if(!this._submitDialog){this._submitDialog=sap.ui.xmlfragment("cus.sd.so.mccs1.ext.fragment.JobSubmitDialog",this);this.getView().addDependent(this._submitDialog);}this._submitDialog.open();},onPressCancel:function(o){if(this._oDialog){this._oDialog.destroy();this.oDialog=null;}},_prepareActionItemsChangeAttr:function(e){var f=[];return f;},_prepareFilters:function(f,e){for(var i=0;i<f.length;i++){var o=f[i];var _=o.hasOwnProperty('aFilters');if(_&&o.aFilters){this._prepareFilters(o.aFilters,e);}else{e.push(o);}}return e;},_createDataForInclusionCaseSuccess:function(e){this._showMessageToast("inclusionCaseSuccess");},_createDataForInclusionCaseFail:function(e){this._showMessageToast("errorOccured");},cancelJob:function(){this._submitDialog.destroy();this._submitDialog=null;},_prepareActionFilters:function(e){var A=[];A.push(new F(d.DOCUMENT_CATEGORY.NAME,b.EQ,d.DOCUMENT_CATEGORY.IF_SALES_ORDER));return A;},_filterHelper:function(i){return i.SlsDocMassChgActionCategory===this.sActionCateory&&i.SlsDocMassChgEntityLevel===this.sEntityLevel;},_filterAndSetActions:function(A){var e=Object.values(d.ENTITY_LEVEL);var D=this.getView().getModel("actionModel");for(var i=0;i<e.length;i++){var f=A.filter(this._filterHelper,{sActionCateory:"CHG",sEntityLevel:e[i]});var g=A.filter(this._filterHelper,{sActionCateory:"CHK",sEntityLevel:e[i]});var h=A.filter(this._filterHelper,{sActionCateory:"CRT",sEntityLevel:e[i]});var p="/"+e[i];D.setProperty(p+"/change",f);D.setProperty(p+"/check",g);D.setProperty(p+"/create",h);}},_changeActionsData:function(){var A=this.getView().getModel("actionModel");var p="/"+this._tabUtility.getEntityLevel();A.setProperty("/actionData",A.getProperty(p));},_getActionMenuItems:function(){this._destroyFragments();var A=this._prepareActionFilters(d.ACTION_CATEGORY.IF_CHANGE);var p=this._ODataDataSource.readActionMenuItems(A);p.then(function(e){if(e.results.length){this._filterAndSetActions(e.results);}else{this._showMessageToast("actionMenuLoadFailed");}}.bind(this),function(e){this._showMessageToast("actionMenuLoadFailed");}.bind(this));},_showActionFragment:function(f,B){this._changeActionsData();if(!this._actionFragments[f]){this._actionFragments[f]=sap.ui.xmlfragment(f,this);this.getView().addDependent(this._actionFragments[f]);}this._actionFragments[f].openBy(B,false,P.Dock.BeginTop,P.Dock.BeginBottom);},onActionChange:function(e){var B=e.getSource();this._showActionFragment("cus.sd.so.mccs1.ext.fragment.ChangeActionMenu",B);},onActionCheck:function(e){var B=e.getSource();this._showActionFragment("cus.sd.so.mccs1.ext.fragment.CheckActionMenu",B);},onActionCreate:function(e){var B=e.getSource();this._showActionFragment("cus.sd.so.mccs1.ext.fragment.CreateActionMenu",B);},_readActionMenuItemsFail:function(e){this._showMessageToast("errorOccured");},_displayChangeMenuItems:function(e,B){if(e.results.length){var D=this.getView().getModel("dataModel");D.setProperty("/actionData/change",e.results);this._actionChangeMenu=sap.ui.xmlfragment("cus.sd.so.mccs1.ext.fragment.ChangeActionMenu",this);this.getView().addDependent(this._actionChangeMenu);this._actionChangeMenu.openBy(B,false,P.Dock.BeginTop,P.Dock.BeginBottom);}},_displayCheckMenuItems:function(e,B){if(e.results.length){var D=this.getView().getModel("dataModel");D.setProperty("/actionData/check",e.results);this._actionCheckMenu=sap.ui.xmlfragment("cus.sd.so.mccs1.ext.fragment.CheckActionMenu",this);this.getView().addDependent(this._actionCheckMenu);this._actionCheckMenu.openBy(B,false,P.Dock.BeginTop,P.Dock.BeginBottom);}},_displayCreateMenuItems:function(e,B){if(e.results.length){var D=this.getView().getModel("dataModel");D.setProperty("/actionData/create",e.results);this._actionCreateMenu=sap.ui.xmlfragment("cus.sd.so.mccs1.ext.fragment.CreateActionMenu",this);this.getView().addDependent(this._actionCreateMenu);this._actionCreateMenu.openBy(B,false,P.Dock.BeginTop,P.Dock.BeginBottom);}},_readPartnerInfoFail:function(e){this._showMessageToast("errorOccured");},_showMessageToast:function(i){var r=this.getView().getModel("@i18n").getResourceBundle();M.show(r.getText(i));},navigateToSupplierFactsheet:function(e){var A=this.extensionAPI;var n=A.getNavigationController();var s=e.getSource().getProperty("text");var p={"Supplier":s};n.navigateExternal("Supplier",p);},onBeforeRebindTableExtension:function(){this._onTabSelect();},onPressPartnerLink:function(e){var p=[];var s=this._tabUtility.getTabSelected();var o=e.getSource().getBindingContext();if(s===d.ID.SALES_ORDER_TAB){p.push(new F(d.DB_FIELD_NAMES.SALES_DOCUMENT_HEADER,b.EQ,o.getProperty("SalesOrder")));}else{p.push(new F(d.DB_FIELD_NAMES.SALES_DOCUMENT,b.EQ,o.getProperty("SalesOrder")));p.push(new F(d.DB_FIELD_NAMES.SALES_DOCUMENT_ITEM,b.EQ,o.getProperty("SalesOrderItem")));}var f={entityLevel:this._tabUtility.getEntityLevel(),partnerFilters:p,btnSource:e.getSource()};this._quickViewComponent.showPartnerQuickView(f);},_destroyFragments:function(){if(this._actionFragments){for(var k in this._actionFragments){if(this._actionFragments.hasOwnProperty(k)){this._actionFragments[k].destroy();}}}this._actionFragments={};},onExit:function(){this.getOwnerComponent().getModel().detachBatchRequestCompleted(this._batchRequestedComplete.bind(this));this._destroyFragments();}});});
