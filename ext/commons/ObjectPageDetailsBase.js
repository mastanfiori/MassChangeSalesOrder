/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/m/MessageToast",'sap/m/MessageItem','sap/m/MessagePopover','sap/ui/core/library',"sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/core/BusyIndicator","sap/ui/core/routing/History","cus/sd/so/mccs1/ext/commons/constants","cus/sd/so/mccs1/ext/commons/TabUtility","sap/ui/comp/odata/MetadataAnalyser","sap/ui/comp/smartfield/SmartField","sap/m/FlexBox","sap/m/HBox","sap/m/Input","sap/ui/core/Icon","sap/ui/core/Fragment","sap/ui/comp/smartform/GroupElement","cus/sd/so/mccs1/ext/commons/Formatter"],function(M,a,b,C,c,J,B,H,d,T,e,S,F,f,I,g,h,G,j){return c.extend("cus.sd.so.mccs1.ext.commons.ObjectPageDetailsBase",{_massChgActionsComponent:null,_readDocSuccessEvent:null,_readDocFailEvent:null,_jobSubmitSuccessEvent:null,_jobSubmiFailEvent:null,_messagePopover:null,_dataModel:null,formatter:j,onInit:function(){this._dataModel=new J({submitButtonEnable:false,customFieldVisible:false,errroMessagesBtnVisible:false,errroMessages:[],errroMessagesCount:0,changeOperation:{changeCurrentValueKey:d.OBJECT_PAGE.CHANGE_CURRENT_VALUE,deleteCurrentValueKey:d.OBJECT_PAGE.DELETE_CURRENT_VALUE},readOnlyData:{}});this.stateModel=this.getOwnerComponent().getModel("stateModel");this.getView().setModel(this.stateModel,"stateModel");this.getView().setModel(this._dataModel,"dataModel");this._tabUtility=T.getInstance();this.getOwnerComponent().getService("ShellUIService").then(function(s){s.setBackNavigation(function(){this.onCancel();}.bind(this));}.bind(this));},_getMetaDataAnalyser:function(){if(!this._oMetaDataAnalyser){this._oMetaDataAnalyser=new e(this.getView().getModel());}return this._oMetaDataAnalyser;},_extensibilityManageComponent:function(){var i=this._tabUtility.getEntityLevel();var E=this._getMetaDataAnalyser().getFieldsByEntityTypeName("SlsDocReqType").filter(jQuery.proxy(function(o){var k="";if(i===d.ENTITY_LEVEL.IF_SALES_ORDER){k=d.EXTENSION.EXTENSION_ENTITY_TYPE.HEADER;}else if(i===d.ENTITY_LEVEL.IF_SALES_ORDER_ITEMS){k=d.EXTENSION.EXTENSION_ENTITY_TYPE.ITEM;}if(o.name.endsWith(k)){return true;}return false;},this));return E;},_getState:function(o){var i={"visible":true,"currentOperation":"","key":o.name,"value":""};return i;},_addExtensionData:function(s,o){var E=this._extensibilityManageComponent();if(!E.length){this._dataModel.setProperty("/customFieldVisible",false);return;}this._dataModel.setProperty("/customFieldVisible",true);var k=this.stateModel.getProperty("/CustomData");var l=this.getCustomFieldGroupControl();this.destroyGroupElements();for(var i=0;i<E.length;i++){k[E[i].name]=this._getState(E[i]);var m=new f({width:'1.5rem'});var n=new I({value:'{dataModel>/readOnlyData/'+E[i].name+'}',width:'20rem',editable:false});var p=new S({visible:{path:'stateModel>currentOperation',formatter:this.onCCVOperationFormatter.bind(this)},value:'{'+E[i].name+'}',change:this.onValueChange.bind(this),width:'20rem',mandatory:true,fieldGroupIds:this.getSmartFieldId()}).addStyleClass("smartFiledObjectPage");var q=new F({renderType:"Bare"});var r=new sap.ui.comp.smartform.GroupElement({label:E[i]['sap:label'],useHorizontalLayout:true});r.bindElement('stateModel>/CustomData/'+E[i].name);q.addItem(n);q.addItem(m);q.addItem(p);h.load({type:"XML",name:'cus.sd.so.mccs1.ext.commons.fragment.ChangeMenu',controller:this}).then(function(t,u){t.insertItem(u,2);}.bind(this,q));h.load({type:"XML",name:'cus.sd.so.mccs1.ext.commons.fragment.DeleteValue',controller:this}).then(function(t,u){t.insertItem(u,4);}.bind(this,q));r.addElement(q);l.addGroupElement(r);}},onTargetMatched:function(){this._dataModel.setProperty("/errroMessagesBtnVisible",false);if(!this._tabUtility.getExtensionApi()){B.hide();this.onCancel();return;}this._addExtensionData();this.getView().getModel().setDeferredGroups(["ObjectPageFieldGroupId"]);this.getView().setBindingContext(this.getView().getModel().createEntry("/SlsDocReadReq",{groupId:"ObjectPageFieldGroupId"}));this._dataModel.setProperty("/readOnlyData",null);var p=this._prepareParams([],true);if(!this._massChgActionsComponent){this._massChgActionsComponent=sap.ui.getCore().createComponent({name:"cus.sd.libmccs1.components.actions",settings:{extensionAPI:this._tabUtility.getExtensionApi(),model:this.getView().getModel()}});this._addEvents();}this._massChgActionsComponent.getServiceDocDetails(p);},_deleteViewBindingContext:function(){var o=this.getView().getBindingContext();if(o){this.getView().getModel().deleteCreatedEntry(o);}},getServiceDocDetailsSuccess:function(E){var D=E.getParameter('data');var s=this._tabUtility.getSelectOption();if(s!==d.ROW_SELECTION_CASE.IF_INCLUSION){D=D.__batchResponses[1].__changeResponses[0].data;}if(!D){return;}this._dataModel.setProperty("/readOnlyData",D.to_MassChangeReadRequest);B.hide();},getServiceDocDetailsFail:function(i){B.hide();this._dataModel.setProperty("/readOnlyData",null);this._showMessageToast("docReadFailed");},onDCVOperationFormatter:function(o){if(o&&o===d.OBJECT_PAGE.DELETE_CURRENT_VALUE){return true;}return false;},onCCVOperationFormatter:function(o){if(o&&o===d.OBJECT_PAGE.CHANGE_CURRENT_VALUE){return true;}return false;},onMenuItemClick:function(E){var k=E.getParameter('item').getKey();var v=(k===d.OBJECT_PAGE.DELETE_CURRENT_VALUE)?d.OBJECT_PAGE.NO_VALUE:"";this.setUiStateData(E.getSource().getBindingContext('stateModel'),false,v,k);},onValueChange:function(E){var s=E.getSource();var o=s.getBindingContext("stateModel");this.stateModel.setProperty(o.getPath()+"/value",E.getSource().getValue());this._validateValWithValueList(E);},onUndoClick:function(E){var o=E.getSource().getBindingContext('stateModel');this.setUiStateData(o,true);var s=this.getView().getBindingContext();s.getModel().setProperty(s.getPath()+"/"+o.getProperty('key'),null);},setUiStateData:function(o,v,V,O){this.stateModel.setProperty(o.getPath()+"/visible",v);this.stateModel.setProperty(o.getPath()+"/value",V?V:"");this.stateModel.setProperty(o.getPath()+"/currentOperation",O?O:"");},resetUiStateData:function(){this.getOwnerComponent().loadStateModel();this._dataModel.setProperty("/errroMessagesBtnVisible",false);this.setSelectedSubSection();this.destroyGroupElements();},onLaunchPadBack:function(){this.resetUiStateData();},getErrorMessagesCount:function(E){return E.length;},errorBtnVisibleFormatter:function(i,E){if(!E.length){return false;}return i;},onMessagePopoverPress:function(E){if(!this._messagePopover){var m=new a({type:'{dataModel>type}',title:'{dataModel>title}',subtitle:'{dataModel>subtitle}'});this._messagePopover=new b({items:{path:'dataModel>/errroMessages',template:m}});}this.byId("messagePopoverBtn").addDependent(this._messagePopover);this._messagePopover.openBy(E.getSource());},_getMessageObject:function(m){return{type:C.MessageType.Error,title:"",subtitle:'',target:null};},_getCurrentInputControlIndex:function(E,t){for(var i=0;i<E.length;i++){if(E[i].target===t){return i;}}return-1;},_getErrorMsg:function(i,p){if(!i.getValue()||i.getValueState()==="Error"){var o=this.getView().getModel("i18n");var t=i.getBindingContext().getPath()+"/"+i.getBindingPath("value");if(i.getValueState()!=="Error"){i.setValueStateText(o.getResourceBundle().getText("blankInputError"));i.setValueState("Error");}var m=this._getMessageObject();m.title=i.getValueStateText();m.subtitle=p;m.target=t;return m;}return null;},_checkInputs:function(){var s=this.getAllEditableSmartFields();var E=[];for(var i=0;i<s.length;i++){var o=s[i];var k=(o instanceof sap.ui.comp.smartfield.SmartField);if(k&&o.getVisible()){var l=o.getContent();if(l instanceof sap.m.CheckBox){continue;}var m=this._getErrorMsg(l,l.getParent().getComputedTextLabel());if(m){E.push(m);}}}this._dataModel.setProperty("/errroMessages",E);if(E.length){return false;}return true;},onSubmitClick:function(E){var v=this._checkInputs();if(!v){this._dataModel.setProperty("/errroMessagesBtnVisible",true);return;}this._dataModel.setProperty("/errroMessagesBtnVisible",false);var u=this.stateModel.getProperty("/");var o=[];for(var i in u){var U=u[i];for(var k in U){var l=U[k];if(l.currentOperation){if(l.currentOperation===d.OBJECT_PAGE.DELETE_CURRENT_VALUE){o.push({key:l.key,value:""});}else{var m=this.getView().getBindingContext().getObject()[l.key];var n=m?m:l.value;if(n){o.push({key:l.key,value:n});}}}}}if(o.length){var p=this._prepareParams(o,false);this._massChgActionsComponent.openSubmitDataDialog(E,p);}else{this._showMessageToast("noAttributesModified");}},onCancel:function(){this._deleteViewBindingContext();var o=H.getInstance();var p=o.getPreviousHash();if(p!==undefined){window.history.go(-1);}else{window.history.back();}this.resetUiStateData();},jobSubmitSuccess:function(i){this._showMessageToast("docReadSubmitSuccess");this.onCancel();},jobSubmitFail:function(i){this._showMessageToast("docReadSubmitFailed");},getEntitySet:function(){var i=this._tabUtility.getEntityLevel();var k=d.ODATA.ENTITYSET.MC_SALES_ORDER;if(i!==d.ENTITY_LEVEL.IF_SALES_ORDER){k=d.ODATA.ENTITYSET.MC_SALES_ORDER_ITEM;}return k;},_prepareParams:function(o,s){var p={jobName:"",simulate:s,entityLevel:this._tabUtility.getEntityLevel(),entitySet:this.getEntitySet(),selectedContext:this._tabUtility.getSelectedContext(),documentCategory:d.DOCUMENT_CATEGORY.IF_SALES_ORDER,caseType:this._tabUtility.getSelectOption(),actionId:this.getActionId(),actionDescription:this.getActionDescription(),changeAttributes:o,filters:this._tabUtility.getFilters(),selectQueryAttributes:this.getSelectAttributes()};return p;},_showMessageToast:function(i){var o=this.getView().getModel("i18n");if(o){var r=o.getResourceBundle();M.show(r.getText(i));}},_addEvents:function(){if(this._massChgActionsComponent){this._readDocSuccessEvent=this.getServiceDocDetailsSuccess.bind(this);this._massChgActionsComponent.attachDocReadSuccess(this._readDocSuccessEvent);this._readDocFailEvent=this.getServiceDocDetailsFail.bind(this);this._massChgActionsComponent.attachDocReadError(this._readDocFailEvent);this._jobSubmitSuccessEvent=this.jobSubmitSuccess.bind(this);this._massChgActionsComponent.attachActionSuccess(this._jobSubmitSuccessEvent);this._jobSubmiFailEvent=this.jobSubmitFail.bind(this);this._massChgActionsComponent.attachActionError(this._jobSubmiFailEvent);}},_removeEvents:function(){if(this._massChgActionsComponent){this._massChgActionsComponent.detachDocReadSuccess(this._readDocSuccessEvent);this._massChgActionsComponent.detachDocReadError(this._readDocFailEvent);this._massChgActionsComponent.detachActionSuccess(this._jobSubmitSuccessEvent);this._massChgActionsComponent.detachActionError(this._jobSubmiFailEvent);}},_destoryActionsComponent:function(){if(this._massChgActionsComponent){this._removeEvents();this._massChgActionsComponent.destroy();this._massChgActionsComponent=null;}},destroyGroupElements:function(){var i=this._dataModel.getProperty("/customFieldVisible");if(i){var k=this.getCustomFieldGroupControl();k.destroyGroupElements();}},_extractIdFromDescription:function(v){var V=v.split(" ");if(V.length>1){var l=V[V.length-1];v=l.substr(l.lastIndexOf("(")+1,l.lastIndexOf(")")-1);}return v;},_validateValWithValueList:function(E){var s=E.getSource();var v=this._extractIdFromDescription(s.getValue());var i=this.getView().getModel("i18n");if(v){var D=s.getDataProperty();var k=D.property["com.sap.vocabularies.Common.v1.ValueList"].CollectionPath.String;var p=D.typePath;if(k){var m=this.getView().getModel();var l=[];var o=new sap.ui.model.Filter(p,"EQ",v);l.push(o);m.read("/"+k,{filters:l,success:function(n){if(n.results.length===0){s.setValueStateText(i.getResourceBundle().getText("invalidInputError",v));s.setValueState("Error");}else{s.setValueState("None");}}});}}},onExit:function(){this._destoryActionsComponent();}});});
